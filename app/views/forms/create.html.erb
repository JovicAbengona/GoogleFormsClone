<div class="container">
    <div class="mt-3 col-lg-8 offset-lg-2">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/" class="text-success text-decoration-none">Dashboard</a></li>
                <li class="breadcrumb-item active" aria-current="page">Create Form</li>
            </ol>
        </nav>
        <% if flash[:publish_message] %>
            <div class="alert alert-<%= flash[:publish_message]["alert_type"] %>" role="alert">
                <i class="fas fa-<%= flash[:publish_message]["icon"] %>-circle"></i> <%= flash[:publish_message]["message"] %>
            </div>
        <% end %>

        <div class="mb-3">
            <form action="/update_form_title" method="post">
                <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                <input type="hidden" name="_method" value="patch">
                <input type="hidden" name="form[id]" value="<%= @form_data['id'] %>">
                <input type="text" name="form[title]" id="form_title_text" class="form-control" placeholder="Form Title" value="<%= @form_data['title'] if @form_data.present? %>" <% if @form_data['status'] === 0 %> autofocus <% elsif @form_data['status'] === 1 %> readonly <% end %>>
            </form>
        </div>
        <div class="mb-3">
            <form action="/update_form_description" method="post">
                <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                <input type="hidden" name="_method" value="patch">
                <input type="hidden" name="form[id]" value="<%= @form_data['id'] %>">
                <textarea id="form_description_textarea" class="form-control" name="form[description]" rows="3" placeholder="Form Description" <% if @form_data['status'] === 1 %> readonly <% end %>><%= @form_data['description'] if @form_data.present? %></textarea>
            </form>
        </div>
        <div id="sortable">
            <% @questions.each do |question| %>
                <div id="form_question_<%= question['id'] %>_div" class="mb-3 p-4 border border-success rounded form_question" data-question-type="<%= question['question_type'] %>">
                    <div class="row">
                        <div class="col-lg-<% if @form_data['status'] === 0 %>9<% elsif @form_data['status'] === 1%>12<% end %>">
                            <div id="form_question_<%= question['id'] %>_question_div" class="input-group mb-3">
                                <input type="text" id="form_question_<%= question['id'] %>" name="form[form_question_<%= question['id'] %>]" class="form-control form-control-lg" placeholder="Question Text" value="<%= question['content'] %>" <% if @form_data['status'] === 1 %> readonly <% end %>>
                                <% if @form_data['status'] === 0 %>
                                    <button type="button" class="delete_question btn btn-sm btn-outline-danger" data-delete-id="<%= question['id'] %>"><i class="far fa-trash-alt"></i> Delete</button>
                                <% end %>
                            </div>
                            <% @all_options.each do |option| %>
                              <% if question['id'] == option["question_id"] %>
                                <div id="form_question_<%= question['id'] %>_choice_div" class="input-group mb-3 type_multiple_choice">
                                    <% if @form_data["form_type"] === 1 %>
                                        <div class="input-group-text form_question_choice_answer">
                                            <input name="form[form_question_<%= question['id'] %>_choice_<%= option['id'] %>_quiz]" class="form-check-input mt-0" type="checkbox">
                                        </div>
                                    <% end %>
                                    <input type="text" id="form_question_<%= question['id'] %>_choice_<%= option['id'] %>" name="form[form_question_<%= question['id'] %>_choice_<%= option['id'] %>]" class="form-control" placeholder="Choice Text" data-choice-id="<%= option['id'] %>" value="<%= option['content'] %>" <% if @form_data['status'] === 1 %> readonly <% end %>>
                                    <% if @form_data['status'] === 0 %>
                                        <button type="button" class="delete_choice btn btn-sm btn-outline-danger" data-delete-id="<%= option['id'] %>"><i class="far fa-trash-alt"></i> Delete</button>
                                    <% end %>
                                </div>
                              <% end %>
                            <% end %>
                            <% if @form_data['status'] === 0 && (question['question_type'] === 1 || question['question_type'] === 2) %>
                                <div id="form_question_<%= question['id'] %>_add_choice_other_div">
                                    <a id="form_question_<%= question['id'] %>_add_choice" class="add_choice text-decoration-none text-success" data-add-choice-id="<%= question['id'] %>">Add Choice</a> <span id="form_question_<%= question['id'] %>_add_other_div">or <a id="form_question_<%= question['id'] %>_add_other" class="add_other text-decoration-none text-success" data-add-other-id="<%= question['id'] %>">"Other"</a></span>
                                </div>
                            <% end %>
                            <% if @form_data["form_type"] === 1 %>
                                <div id="form_question_<%= question['id'] %>_score_div" class="input-group my-2 score_field">
                                    <input type="text" placeholder="Score" name="form[form_question_<%= question['id'] %>_score] class="form-control form-control-lg"">
                                </div>
                            <% end %>
                        </div>
                        <% if @form_data['status'] === 0 %>
                            <form id="form_question_<%= question['id'] %>_change_type" action="/update_question_type" method="patch">
                                <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                                <input type="hidden" name="_method" value="patch">
                                <input type="hidden" name="form[question_id]" value="<%= question['id'] %>">
                                <div class="col-lg-3">
                                    <select id="form_question_<%= question['id'] %>_type" name="form[question_type]" class="form-select form_question_type" data-question-type-id="<%= question['id'] %>">
                                        <option value="1" <% if question['question_type'] === 1 %> selected <% end %>>Multiple Choice</option>
                                        <option value="2" <% if question['question_type'] === 2 %> selected <% end %>>Checkboxes</option>
                                        <option value="3" <% if question['question_type'] === 3 %> selected <% end %>>Short Answer</option>
                                        <option value="4" <% if question['question_type'] === 4 %> selected <% end %>>Paragraph</option>
                                    </select>
                                </div>
                            </form>
                        <% end %>
                    </div>
                </div>
            <% end %>
        </div>
        <% if @form_data['status'] === 0 %>
            <div class="mb-3">
                 <button type="button" id="add_question_btn" class="btn btn-sm btn-outline-success w-100 p-2" data-form-id=<%= @form_data['id'] if @form_data.present? %>><i class="fas fa-plus"></i> Add Question</button>
            </div>
        <% end %>

        <form action="/form/<%= @form_action %>/<%= @form_data['id'] %>/<%= @form_data['code'] %>" id="publish_form" method="POST">
            <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
            <input type="hidden" name="_method" value="patch">
            <% if @form_data['status'] === 0 %>
                <div class="mb-3">
                    <button type="submit" class="btn btn-sm btn-success w-100 p-3"><i class="fas fa-paper-plane"></i> Publish Form</button>
                </div>
            <% elsif @form_data['status'] === 1 %>
                <div class="mb-3">
                    <button type="submit" class="btn btn-sm btn-secondary w-100 p-3"><i class="fas fa-save"></i> Get Results</button>
                </div>
            <% end %>
        </form>
        <% if @form_data['status'] === 0 %>
            <div class="mb-3">
                <button type="button" id="add_question_btn" class="btn btn-sm btn-outline-danger w-100 p-2" data-bs-toggle="modal" data-bs-target="#delete_modal"><i class="far fa-trash-alt"></i> Delete Form</button>
            </div>
        <% end %>
    </div>
</div>

<!-- DELETE MODAL -->
<div class="modal fade" id="delete_modal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="delete_modal_label" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-light">
                <h5 class="modal-title" id="delete_modal_label"><i class="fas fa-exclamation-triangle"></i> Warning!</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
            Are you sure you want to delete this form? This action can't be undone.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <form action="/form/delete/<%= @form_data["id"] %>" method="POST">
                    <input type="hidden" name="authenticity_token" value="<%= form_authenticity_token %>">
                    <input type="hidden" name="_method" value="delete">
                    <button type="submit" class="btn btn-outline-danger">Delete</button>
                </form>
            </div>
        </div>
    </div>
</div>